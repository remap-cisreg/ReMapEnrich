---
title: "Roken: enrichment of genomic regions"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Roken}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(collapse = T, comment = "#>")
options(tibble.print_min = 4L, tibble.print_max = 4L)
library(dplyr)
```

# Quick example

This quick example is based on pet datasets released with the roken package. 

It will go through the folowing steps. 

1. Load a minimal example

    - a query set of genomic regions. 
    - (reduced) catalogue of reference genomic regions. 

2. Compute the enrichment of intersections between the query and each entry of the catalogue. 

```{r}
# Load the roken library
library(roken) 

# Load the example dataset
query <- BedToGranges(system.file("extdata",
                                    "ReMap_nrPeaks_public_chr22_SOX2.bed",
                                    package = "roken"))

catalog <- BedToGranges(system.file("extdata",
                                    "ReMap_nrPeaks_public_chr22.bed",
                                    package = "roken"))
```

We now dispose of two genomic ranges object.
The catalogue contains features names.

```{r}
enrichment <- GrEnrichment(query, catalog)
```

The data frame enrichment now contains all the features of the catalogue with their enrichment values.
The column "adjusted.significance" is the one ordering the data frame.
It is important to specify that this example is only relevant for the hg19 assembly.
If any other assembly is computed, the parameter "chromSizes" should be acknowledged consequently.

## Data loading 

## Downloading reMap2 catalogue

```{r}
# Create a local directory for the tutorial
demo.dir <- "~/roken_demo"
dir.create(demo.dir, showWarnings = FALSE, recursive = TRUE)
setwd(demo.dir)
# Use the function LoadRemapCatalog
remapCatalog <- LoadRemapCatalog("nrpeaks_all.bed.gz")
```

The genomic ranges object remapCatalog now contains the full reMap2 catalogue.
A file has also been downloaded at "~/roken_demo/nrpeaks_all.bed.gz" (0.5 G).

## Loading a custom catalogue

## Loading query region set

## Loading chromosome sizes

```{r}
# This call will not create any file but only load the data in a vector.
rn5ChromSizes <- LoadUcscChromSizes("rn5")
# It is also possible to load the chromosomes sizes of any species in a file during the process.
rn5ChromSizes <- LoadUcscChromSizes("rn5", "rn5_chrom_sizes.txt")
```

The vector rn5ChromSizes now contains all the chromosomes for the rattus norvegicus and their respective lengths.
A file has also been downloaded at "~/roken_demo/rn5_chrom_sizes.txt".

## Negative control

A negative control consists in submitting datasets known to be under the null hypothesis. One approach is to pick up at random genomic regions of the same sizes as the query set. In principle the software should return no significant overlap. 

```{r}
## Generate a randomized query set
shuffledQuery <- GrShuffle(query)
shuffledEnrichment <- GrEnrichment(shuffledQuery, catalog)
```


# Displaying the results

## P-value histogram

```{r}
par(mfrow = c(2,1))
hist(enrichment$adjusted.p.value, breaks=20)
hist(shuffledEnrichment$adjusted.p.value, breaks=20)
par(mfrow = c(1,1))
```